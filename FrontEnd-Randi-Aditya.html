<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Test Front End (Randi Aditya)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    .form-group {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    label {
      width: 100px;
      text-align: right;
      margin-right: 10px;
    }

    select,
    input[type="text"],
    textarea {
      padding: 5px;
      width: 200px;
    }

    textarea {
      resize: none;
      height: 90px;
    }

    .post {
      border: 1px solid #ccc;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
    }

    #postsContainer {
      margin-top: 20px;
    }
  </style>
</head>

<body>

  <h2>Test Front End Developer (Randi Aditya)</h2>

  <div class="form-group">
    <label for="CountrySelect">Negara :</label>
    <select id="CountrySelect">
      <option value="">-- Pilih --</option>
    </select>
  </div>

  <div class="form-group">
    <label for="HarbourSelect">Pelabuhan :</label>
    <select id="HarbourSelect">
      <option value="">-- Pilih --</option>
    </select>
  </div>

  <div class="form-group">
    <label for="GoodSelect">Barang :</label>
    <select id="GoodSelect">
      <option value="">-- Pilih --</option>
    </select>
  </div>

  <div class="form-group">
    <label for="Deskrip"></label>
    <textarea id="Deskrip" readonly></textarea>
  </div>

  <div class="form-group">
    <label for="Disc">Discount :</label>
    <input id="Disc" name="Disc" type="text" value="0" maxlength="3" style="max-width: 30px;"
      onkeyup="this.value=formatRupiah(this.value); hitungHarga();"> %
  </div>

  <div class="form-group">
    <label for="Harga">Harga :</label>
    <input id="Harga" name="Harga" type="text" value="0" onkeyup="this.value=formatRupiah(this.value); hitungHarga();">
  </div>

  <div class="form-group">
    <label for="Total">Total :</label>
    <input id="Total" name="Total" type="text" readonly>
  </div>

  <script>
    const CountrySelect = document.getElementById('CountrySelect');
    const HarbourSelect = document.getElementById('HarbourSelect');
    const GoodSelect = document.getElementById('GoodSelect');

    // Ambil daftar negara
    fetch('http://202.157.176.100:3001/negaras')
      .then(response => response.json())
      .then(countrys => {
        countrys.forEach(country => {
          const option = document.createElement('option');
          option.value = country.id_negara;
          option.textContent = country.id_negara + ' - ' + country.nama_negara;
          CountrySelect.appendChild(option);
        });
      });

    // Event ketika combo box berubah
    CountrySelect.addEventListener('change', () => {
      const countryId = CountrySelect.value;
      document.getElementById('Disc').value = 0;
      document.getElementById('Harga').value = 0;
      document.getElementById('Total').value = 0;
      document.getElementById('Deskrip').value = '';

      if (countryId) {
        fetch(`http://202.157.176.100:3001/pelabuhans?filter={"where" : {"id_negara":${countryId}}}`)
          .then(response => response.json())
          .then(harbours => {
            HarbourSelect.innerHTML = '';
            HarbourSelect.innerHTML = '<option value="">-- Pilih --</option>';
            GoodSelect.innerHTML = '<option value="">-- Pilih --</option>';
            if (harbours.length === 0) {
              alert("Data Kosong");
              return;
            }
            harbours.forEach(harbour => {
              const option = document.createElement('option');
              option.value = harbour.id_pelabuhan;
              option.textContent = harbour.id_pelabuhan + ' - ' + harbour.nama_pelabuhan;
              HarbourSelect.appendChild(option);
            });
          });
      }
      if (CountrySelect.selectedIndex === 0) {
        HarbourSelect.innerHTML = '<option value="">-- Pilih --</option>';
        GoodSelect.innerHTML = '<option value="">-- Pilih --</option>';
        document.getElementById('Disc').value = 0;
        document.getElementById('Harga').value = 0;
        document.getElementById('Total').value = 0;
        document.getElementById('Deskrip').value = '';
      }
    });

    HarbourSelect.addEventListener('change', () => {
      const harbourId = HarbourSelect.value;
      document.getElementById('Disc').value = 0;
      document.getElementById('Harga').value = 0;
      document.getElementById('Total').value = 0;
      document.getElementById('Deskrip').value = '';

      if (harbourId) {
        fetch(`http://202.157.176.100:3001/barangs?filter={"where" : {"id_pelabuhan":${harbourId}}}`)
          .then(response => response.json())
          .then(goods => {
            GoodSelect.innerHTML = '';
            GoodSelect.innerHTML = '<option value="">-- Pilih --</option>';
            if (goods.length === 0) {
              alert("Data Kosong");
              return;
            }
            goods.forEach(good => {
              const option = document.createElement('option');
              option.value = good.id_barang;
              option.textContent = good.id_barang + ' - ' + good.nama_barang;
              option.dataset.deskripsi = good.description;
              option.dataset.diskon = good.diskon;
              option.dataset.harga = good.harga;
              GoodSelect.appendChild(option);
            });

            GoodSelect.addEventListener('change', function () {
              const selectedOption = this.options[this.selectedIndex];
              const harga = selectedOption.dataset.harga;
              const diskon = selectedOption.dataset.diskon;
              const deskripsi = selectedOption.dataset.deskripsi;

              if (GoodSelect.selectedIndex === 0) {
                document.getElementById('Disc').value = 0;
                document.getElementById('Harga').value = 0;
                document.getElementById('Total').value = 0;
                document.getElementById('Deskrip').value = '';
              }
              else {
                document.getElementById('Disc').value = formatRupiah(diskon);
                document.getElementById('Harga').value = formatRupiah(harga);
                document.getElementById('Deskrip').value = deskripsi;
                hitungHarga();
              }
            });

          });
      }
      if (HarbourSelect.selectedIndex === 0) {
        GoodSelect.innerHTML = '<option value="">-- Pilih --</option>';
        document.getElementById('Disc').value = 0;
        document.getElementById('Harga').value = 0;
        document.getElementById('Total').value = 0;
        document.getElementById('Deskrip').value = '';
      }
    });

    function formatRupiah(angka, prefix) {
      var number_string = angka.replace(/[^,\d]/g, '').toString(),
        split = number_string.split(','),
        sisa = split[0].length % 3,
        rupiah = split[0].substr(0, sisa),
        ribuan = split[0].substr(sisa).match(/\d{3}/gi);

      if (ribuan) {
        separator = sisa ? '.' : '';
        rupiah += separator + ribuan.join('.');
      }

      rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
      return prefix == undefined ? rupiah : (rupiah ? 'Rp. ' + rupiah : '');
    }

    function hitungHarga() {
      const harga = parseFloat(document.getElementById("Harga").value.split(".").join("").split(",").join("."));
      const diskon = parseFloat(document.getElementById("Disc").value.split(".").join("").split(",").join("."));

      if (isNaN(diskon)) {
        //alert("Masukkan angka yang valid!");
        document.getElementById("Disc").value = 0;
        document.getElementById("Total").value = 'Rp. ' + formatRupiah(harga.toFixed(0));
        return;
      }
      else {
        const hargaSetelahDiskon = harga - (harga * (diskon / 100));
        document.getElementById("Total").value = 'Rp. ' + formatRupiah(hargaSetelahDiskon.toFixed(0));
      }

      if (isNaN(harga)) {
        //alert("Masukkan angka yang valid!");
        document.getElementById("Harga").value = 0;
        document.getElementById("Total").value = '';
        return;
      }
      else {
        const hargaSetelahDiskon = harga - (harga * (diskon / 100));
        document.getElementById("Total").value = 'Rp. ' + formatRupiah(hargaSetelahDiskon.toFixed(0));
      }
    }

  </script>

</body>

</html>
